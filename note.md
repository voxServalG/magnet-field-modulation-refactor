# 验证记录

## 2026-01-11
- **任务**: 比较 `离散化磁场计算及优化算法Bx` 目录下的 `la_saved.mat` 与 `python_refactor/compare_la.py` 的计算结果。
- **结果**: **匹配 (Match)**。
- **详细数据**:
    - 最大绝对误差: `9.88e-07`
    - 参考值量级: `6.82e+06`
    - 相对误差: 约 `1.45e-13`
- **结论**: Python 重构代码成功复现了 MATLAB 的流函数系数 (la) 计算逻辑。微小差异属于正常的浮点运算精度范围。

## 2026-01-11 补充：物理仿真核心坑点记录

### 1. 任务：验证 `main.py` 正向物理仿真结果
- **现象**: 初始仿真结果显示中心磁场 $B_0$ 接近 0（$2.3 \times 10^{-3} \text{ nT}$），相对误差高达 0^7 \%$。
- **定位**: 发现 `physics.py` 中的电流方向逻辑存在“二次修正”错误。
- **坑点描述**: 
    - **误区**: 认为必须手动判断线圈的顺逆时针（Shoelace 算法）并强制修正电流正负。
    - **真相**: 流函数 $\Phi$ 的等值线提取函数 (`contour`) 返回的点序列已经天然包含了梯度方向信息。
    - **后果**: 手动修正方向导致了“山峰”（正值区）与“盆地”（负值区）的磁场由相互配合变成了相互抵消。
- **修复**: 在 `calculate_field_from_coils` 中移除 `direction_sign` 的干扰，直接信任 `contour` 生成的路径方向。
- **最终结果**: 
    - 中心磁场恢复至 **383.53 nT**。
    - 均匀度误差 **1.27%**，完美对标 MATLAB 原版。

---
**下班总结**: 尊重数学原生的拓扑结构，不要在物理积分层做多余的逻辑干预。

## 15 Jan
- 在特定线圈平面位置及特定目标点位置下，A作为系统 连接了 流函数系数(i) 与 目标点的磁感应强度(o)
- 基于 need for varied target point, attempt to develop "A generator" and replace static `A` into active ones.
- **参数单位及物理意义**
  - `L` / m
    - 线圈0.5倍边长。
    - 线圈板是一个边长为 `2L` 的正方形.
  - `a` / m
    - 两个Bx线圈分别位于 `z=a`, `z=-a`上。

## 18 Jan: 阵列化主动屏蔽仿真流程 (Array Simulation Workflow)

### 抽象目标
构建一个基于**线性叠加原理**的系统。该系统由多个三轴线圈单元 (Bx/By/Bz) 组成阵列，通过主动优化各通道电流，来压制/补偿任意给定的背景磁场。

### 实务步骤清单 (Practical Steps Checklist)

#### 步骤 1: 准备“标准单元” (Prepare the Unit)
*   **动作**: 实例化 `CoilFactory`。
*   **配置**: `L=0.85`, `a=0.7`, `modes=(4,4)`, `reg_lambda=1e-14`, `use_shielding=False` (暂忽略屏蔽室)。
*   **执行**: 生成 `unit_bx`, `unit_by`, `unit_bz` 列表，包含几何坐标和单位电流信息。

#### 步骤 2: 定义阵列与目标区域 (Define Array & Target ROI)
*   **阵列几何**: 定义 `Array_Pos` (Nx3) 矩阵，包含每个单元中心的偏移量。
*   **目标区域 (ROI)**: 定义 `Target_Points` (Mx3)，覆盖需要进行磁场压制的空间范围。

#### 步骤 3: 构建响应矩阵 S (Build Response Matrix)
*   **逻辑**: 建立映射关系：单元电流输入 ($3K$) $\to$ ROI 磁场输出 ($3M$)。
*   **结构**: 矩阵 `S`，形状为 $(3M, 3K)$。
*   **循环构建**:
    *   遍历每个 单元 $i$ 和 轴 $j$:
        1.  将标准线圈几何平移 `Array_Pos[i]`。
        2.  调用 `physics.py` 计算其在 `Target_Points` 产生的磁场。
        3.  将结果向量拉直 (Flatten) 为 $3M \times 1$。
        4.  填入 `S` 矩阵的第 $(3i + j)$ 列。

#### 步骤 4: 设定“假想敌” (Define Background Field)
*   **动作**: 创建函数 `B_bg_func(points)` 模拟环境干扰场（如梯度场）。
*   **数据**: 计算并生成 ROI 上的背景场向量 `B_bg_data` $(3M \times 1)$。

#### 步骤 5: 求解与反击 (Solve & Counter-Attack)
*   **数学目标**: 求解方程 $\mathbf{S} \cdot \vec{I} = -\vec{B}_{bg}$。
*   **求解器**: 使用 `np.linalg.lstsq` (最小二乘法) 计算最优电流向量 $\vec{I}_{opt}$。

#### 步骤 6: 最终仿真与验证 (Final Simulation & Verification)
*   **组装**: 构建 `Final_System` 列表。遍历所有通道，平移线圈并赋予 $\vec{I}_{opt}$ 中计算出的对应电流权重。
*   **物理计算**: 计算 `B_total = physics(Final_System) + B_bg`。
*   **验证**: 统计 `B_total` 的残差 (RMS/Max)，验证“压制”效果是否显著（接近零）。

## 进展报告 - 2026/01/18

### 1. 核心算法升级：从 2D 平面到 3D 球体压制
*   **目标升级**: 成功将主动屏蔽的目标区域从原来的单一 Z=0 平面升级为 **3D 球体 (Sphere of Silence)**。
*   **实现细节**:
    *   构建了 $25\times25\times25$ 的体素化采样网格。
    *   采用球形掩膜 (Spherical Masking) 算法，精确界定目标区域（目前设定半径 R=0.6m）。
    *   求解器现在直接对球体内部的所有采样点进行优化，而非仅优化切片。

### 2. 仿真环境增强：引入随机干扰场
*   **背景磁场重构**: 废弃了之前确定性的线性梯度场，改为基于 **“幽灵偶极子” (Phantom Dipoles)** 的随机场生成器。
*   **物理真实性**: 通过在远场随机放置磁偶极子源，生成了既符合麦克斯韦方程（无散无旋发散）、又具有高度随机性和复杂梯度的背景磁场，模拟真实的噪声环境。
*   **蒙特卡洛就绪**: 每次运行都会基于随机种子生成全新的“敌人”，验证了算法在非特定条件下的鲁棒性。

### 3. 可视化系统重构：全套 3D 分析图表
*   **3D 体素渲染**: 实现了球体内部磁场的 3D 散点云图 (Volumetric Scatter Plot)，直观展示球体内部的场强分布。
*   **矢量场对比**: 新增了 **压制前后 3D 矢量风向图** (Vector Field Comparison)，通过同色标下的箭头对比，一目了然地展示压制效果。
*   **阵列结构分解**: 增加了线圈阵列的三轴 (Bx/By/Bz) 独立视图。
*   **视觉纠偏**: 修复了 3D 绘图中的坐标轴比例失真问题，确保球体在视觉上呈现完美的正球形。

### 下一步计划

*   **参数寻优**: 针对 3D 球体，探索最优的正则化参数 ($\lambda$) 以平衡电流功耗与压制率。

*   **分布统计**: 运行多次随机种子，统计不同随机场下的压制率分布（直方图）。

*   **一阶梯度线圈扩展 (Gradient Coils)**:

    *   **目标**: 在目前的 B0 线圈 (Bx/By/Bz) 基础上，增加 5 种一阶梯度线圈（如 Maxwell 组产生 $dB_z/dz$，Golay 组产生 $dB_x/dx$ 等）。

    *   **实施策略**:

        *   **Factory 扩展**: 在 `src/factory.py` 中引入梯度线圈的解析构型。

        *   **矩阵扩容**: 响应矩阵 $S$ 将从单单元 3 通道扩展至 8 通道（3 个主场 + 5 个梯度场），显著提升对非均匀磁场的拟合自由度。

        *   **模块解耦**: 得益于目前的解耦设计，`physics` 模块和 `solver` 模块无需修改即可自动支持新线圈。



## 19 Jan: 配置指南与深度扩展思路



### 1. 快速配置指南 (Quick Config Guide)

所有核心参数均位于 **`run_array_sim.py`**：



*   **线圈阵列拓扑 (Coil Topology)**

    *   **位置**: Line ~40

    *   **参数**: `s` (间距), `offsets` (网格坐标), `layout_list` (每个单元的 [x,y,z])。

    *   **操作**: 修改 `layout_list` 循环逻辑可轻松从 3x3 平面扩展至 4x4 或双层立体阵列。



*   **目标区域 (Target Region)**

    *   **位置**: Line ~60

    *   **参数**: `center_spot` (球心坐标 [x,y,z]), `radius_spot` (球半径 m)。

    *   **原理**: 使用 `np.linalg.norm` 计算 3D 欧氏距离，生成布尔掩膜 `region_mask`，指导求解器仅优化球体内部场强。



### 2. 工程哲学：控制阶数的“苏式截断” (Soviet Truncation)

关于梯度线圈应扩展到多少阶的问题，遵循以下工程原则：

*   **简单即可靠**: 0阶(B0) + 1阶(Gradient) 是性价比极限。2阶以上系统复杂度呈指数上升，但在远场干扰下的收益极低（衰减快，
/r^5$）。

*   **鲁棒性优先**: 高阶线圈对加工和安装公差极其敏感。

*   **结论**: 止步于 **1阶梯度**。打造“磁场界的 AK-47”——皮实、耐用、火力覆盖够用即可，拒绝学术界的“过拟合”炫技。



### 3. 跨学科创新方向 (EE $\to$ BME Cross-over)

利用电子工程 (EE) 背景对传统生物医学工程 (BME) 进行“降维打击”的潜在方向：

*   **非线性监测 (IM2/IMD)**:

    *   **思路**: 利用通信电路中的 **二阶互调 (IM2)** 概念。

    *   **应用**: 发射双导频信号，监测差频分量，以此**主动探测**环境中的隐蔽非线性干扰源（如移动的铁磁物体、屏蔽层饱和）。

*   **前馈控制融合 (Feed-forward with MoCap)**:

    *   **思路**: 引入动作捕捉 (Motion Capture) 系统。

    *   **应用**: 在磁力计读数跳变之前，通过视觉捕捉头动向量，利用物理模型提前预测磁通量变化并施加反向波。将“亡羊补牢”升级为“未卜先知”。

### 4. 核心矩阵构建原理 (Matrix Construction)
为了计算流函数系数或阵列电流，我们需要构建两个关键矩阵：

*   **$A$ 矩阵 (灵敏度矩阵 / Sensitivity Matrix)**
    *   **定义**: 描述“输入电流”与“输出磁场”之间的线性映射关系 ($\mathbf{B} = A \cdot \mathbf{x}$).
    *   **输入参数**:
        1.  **源 (Source)**: 线圈的**几何路径** (Geometry)。对于阵列，是所有单元 ($K$ 个通道) 的 3D 坐标数据。
        2.  **宿 (Sink)**: 目标区域的**采样点坐标** (Target Points)。即 $M$ 个体素中心。
        3.  **物理核**: **毕奥-萨伐尔定律** (Biot-Savart Law)。
    *   **维度**: $(3M \times K)$。

*   **$\Gamma$ 矩阵 (正则化矩阵 / Tikhonov Matrix)**
    *   **定义**: 定义优化过程中的“代价”或“惩罚项” (Penalty Term)。
    *   **输入参数**: 线圈的**电气特性**。通常基于线圈的**电阻 $R$** 或 **电感 $L$**。
    *   **物理意义**:
        *   若 $\Gamma = \mathbf{I}$ (单位阵): 最小化电流平方和 ($\min \sum I^2$)。
        *   若 $\Gamma_{ii} \propto \sqrt{R_i}$: 最小化**热功耗** ($\min P = \sum I^2 R$)。
    *   **作用**: 防止矩阵 $A$ 的病态导致电流震荡，在“拟合精度”与“系统功耗”之间寻找平衡。

    > **代码修改位置指南 (Code Modification Guide)**:
    > *   **$A$ 矩阵参数**:
    >     *   **目标点 (Sink)**: 修改 `run_array_sim.py` 中的 `## 2. Define ROI` 部分。
    >         *   `limit`: 仿真空间的坐标边界 (m)。决定了观测磁场的总体范围（如 $\pm 2.5m$）。
    >         *   `Np`: 单轴采样密度。总采样点数 $M = Np^3$。注意：$Np$ 翻倍，计算量和内存占用将变为 8 倍。
    >         *   `gx, gy, gz`: 坐标轴分量，通过 `linspace(-limit, limit, Np)` 生成。
    >         *   `target_points`: 最终的 $M \times 3$ 坐标矩阵，作为“观察者”传入物理仿真函数。
    >     *   **线圈几何 (Source)**: 
    >         *   单体参数: 修改 `src/factory.py` (如 `L`, `num_turns`) 或 `run_array_sim.py` 的 `config` 字典。
    >         *   阵列排布: 修改 `run_array_sim.py` 中的 `layout` 列表。
    > *   **$\Gamma$ 矩阵参数**:
    >     *   **权重强度**: 修改 `run_array_sim.py` 中 `config` 字典里的 `'reg_lambda'` (默认 `1e-14`)。
    >     *   **结构逻辑**: 目前默认为单位阵 (最小化电流平方)。若要改为最小化**功率** (即引入电阻 $R$ 加权)，需修改 `src/array_manager.py` 中的 `solve_optimization` 方法，构建对角矩阵 `Gamma = diag(sqrt(R))`。


