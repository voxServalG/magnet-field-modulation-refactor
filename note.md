# 验证记录

## 2026-01-11
- **任务**: 比较 `离散化磁场计算及优化算法Bx` 目录下的 `la_saved.mat` 与 `python_refactor/compare_la.py` 的计算结果。
- **结果**: **匹配 (Match)**。
- **详细数据**:
    - 最大绝对误差: `9.88e-07`
    - 参考值量级: `6.82e+06`
    - 相对误差: 约 `1.45e-13`
- **结论**: Python 重构代码成功复现了 MATLAB 的流函数系数 (la) 计算逻辑。微小差异属于正常的浮点运算精度范围。

## 2026-01-11 补充：物理仿真核心坑点记录

### 1. 任务：验证 `main.py` 正向物理仿真结果
- **现象**: 初始仿真结果显示中心磁场 $B_0$ 接近 0（$2.3 \times 10^{-3} \text{ nT}$），相对误差高达 0^7 \%$。
- **定位**: 发现 `physics.py` 中的电流方向逻辑存在“二次修正”错误。
- **坑点描述**: 
    - **误区**: 认为必须手动判断线圈的顺逆时针（Shoelace 算法）并强制修正电流正负。
    - **真相**: 流函数 $\Phi$ 的等值线提取函数 (`contour`) 返回的点序列已经天然包含了梯度方向信息。
    - **后果**: 手动修正方向导致了“山峰”（正值区）与“盆地”（负值区）的磁场由相互配合变成了相互抵消。
- **修复**: 在 `calculate_field_from_coils` 中移除 `direction_sign` 的干扰，直接信任 `contour` 生成的路径方向。
- **最终结果**: 
    - 中心磁场恢复至 **383.53 nT**。
    - 均匀度误差 **1.27%**，完美对标 MATLAB 原版。

---
**下班总结**: 尊重数学原生的拓扑结构，不要在物理积分层做多余的逻辑干预。

## 15 Jan
- 在特定线圈平面位置及特定目标点位置下，A作为系统 连接了 流函数系数(i) 与 目标点的磁感应强度(o)
- 基于 need for varied target point, attempt to develop "A generator" and replace static `A` into active ones.
- **参数单位及物理意义**
  - `L` / m
    - 线圈0.5倍边长。
    - 线圈板是一个边长为 `2L` 的正方形.
  - `a` / m
    - 两个Bx线圈分别位于 `z=a`, `z=-a`上。

## 18 Jan: 阵列化主动屏蔽仿真流程 (Array Simulation Workflow)

### 抽象目标
构建一个基于**线性叠加原理**的系统。该系统由多个三轴线圈单元 (Bx/By/Bz) 组成阵列，通过主动优化各通道电流，来压制/补偿任意给定的背景磁场。

### 实务步骤清单 (Practical Steps Checklist)

#### 步骤 1: 准备“标准单元” (Prepare the Unit)
*   **动作**: 实例化 `CoilFactory`。
*   **配置**: `L=0.85`, `a=0.7`, `modes=(4,4)`, `reg_lambda=1e-14`, `use_shielding=False` (暂忽略屏蔽室)。
*   **执行**: 生成 `unit_bx`, `unit_by`, `unit_bz` 列表，包含几何坐标和单位电流信息。

#### 步骤 2: 定义阵列与目标区域 (Define Array & Target ROI)
*   **阵列几何**: 定义 `Array_Pos` (Nx3) 矩阵，包含每个单元中心的偏移量。
*   **目标区域 (ROI)**: 定义 `Target_Points` (Mx3)，覆盖需要进行磁场压制的空间范围。

#### 步骤 3: 构建响应矩阵 S (Build Response Matrix)
*   **逻辑**: 建立映射关系：单元电流输入 ($3K$) $\to$ ROI 磁场输出 ($3M$)。
*   **结构**: 矩阵 `S`，形状为 $(3M, 3K)$。
*   **循环构建**:
    *   遍历每个 单元 $i$ 和 轴 $j$:
        1.  将标准线圈几何平移 `Array_Pos[i]`。
        2.  调用 `physics.py` 计算其在 `Target_Points` 产生的磁场。
        3.  将结果向量拉直 (Flatten) 为 $3M \times 1$。
        4.  填入 `S` 矩阵的第 $(3i + j)$ 列。

#### 步骤 4: 设定“假想敌” (Define Background Field)
*   **动作**: 创建函数 `B_bg_func(points)` 模拟环境干扰场（如梯度场）。
*   **数据**: 计算并生成 ROI 上的背景场向量 `B_bg_data` $(3M \times 1)$。

#### 步骤 5: 求解与反击 (Solve & Counter-Attack)
*   **数学目标**: 求解方程 $\mathbf{S} \cdot \vec{I} = -\vec{B}_{bg}$。
*   **求解器**: 使用 `np.linalg.lstsq` (最小二乘法) 计算最优电流向量 $\vec{I}_{opt}$。

#### 步骤 6: 最终仿真与验证 (Final Simulation & Verification)
*   **组装**: 构建 `Final_System` 列表。遍历所有通道，平移线圈并赋予 $\vec{I}_{opt}$ 中计算出的对应电流权重。
*   **物理计算**: 计算 `B_total = physics(Final_System) + B_bg`。
*   **验证**: 统计 `B_total` 的残差 (RMS/Max)，验证“压制”效果是否显著（接近零）。

## 进展报告 - 2026/01/18

### 1. 核心算法升级：从 2D 平面到 3D 球体压制
*   **目标升级**: 成功将主动屏蔽的目标区域从原来的单一 Z=0 平面升级为 **3D 球体 (Sphere of Silence)**。
*   **实现细节**:
    *   构建了 $25\times25\times25$ 的体素化采样网格。
    *   采用球形掩膜 (Spherical Masking) 算法，精确界定目标区域（目前设定半径 R=0.6m）。
    *   求解器现在直接对球体内部的所有采样点进行优化，而非仅优化切片。

### 2. 仿真环境增强：引入随机干扰场
*   **背景磁场重构**: 废弃了之前确定性的线性梯度场，改为基于 **“幽灵偶极子” (Phantom Dipoles)** 的随机场生成器。
*   **物理真实性**: 通过在远场随机放置磁偶极子源，生成了既符合麦克斯韦方程（无散无旋发散）、又具有高度随机性和复杂梯度的背景磁场，模拟真实的噪声环境。
*   **蒙特卡洛就绪**: 每次运行都会基于随机种子生成全新的“敌人”，验证了算法在非特定条件下的鲁棒性。

### 3. 可视化系统重构：全套 3D 分析图表
*   **3D 体素渲染**: 实现了球体内部磁场的 3D 散点云图 (Volumetric Scatter Plot)，直观展示球体内部的场强分布。
*   **矢量场对比**: 新增了 **压制前后 3D 矢量风向图** (Vector Field Comparison)，通过同色标下的箭头对比，一目了然地展示压制效果。
*   **阵列结构分解**: 增加了线圈阵列的三轴 (Bx/By/Bz) 独立视图。
*   **视觉纠偏**: 修复了 3D 绘图中的坐标轴比例失真问题，确保球体在视觉上呈现完美的正球形。

### 下一步计划

*   **参数寻优**: 针对 3D 球体，探索最优的正则化参数 ($\lambda$) 以平衡电流功耗与压制率。

*   **分布统计**: 运行多次随机种子，统计不同随机场下的压制率分布（直方图）。

*   **一阶梯度线圈扩展 (Gradient Coils)**:

    *   **目标**: 在目前的 B0 线圈 (Bx/By/Bz) 基础上，增加 5 种一阶梯度线圈（如 Maxwell 组产生 $dB_z/dz$，Golay 组产生 $dB_x/dx$ 等）。

    *   **实施策略**:

        *   **Factory 扩展**: 在 `src/factory.py` 中引入梯度线圈的解析构型。

        *   **矩阵扩容**: 响应矩阵 $S$ 将从单单元 3 通道扩展至 8 通道（3 个主场 + 5 个梯度场），显著提升对非均匀磁场的拟合自由度。

        *   **模块解耦**: 得益于目前的解耦设计，`physics` 模块和 `solver` 模块无需修改即可自动支持新线圈。



## 19 Jan: 配置指南与深度扩展思路



### 1. 快速配置指南 (Quick Config Guide)

所有核心参数均位于 **`run_array_sim.py`**：



*   **线圈阵列拓扑 (Coil Topology)**

    *   **位置**: Line ~40

    *   **参数**: `s` (间距), `offsets` (网格坐标), `layout_list` (每个单元的 [x,y,z])。

    *   **操作**: 修改 `layout_list` 循环逻辑可轻松从 3x3 平面扩展至 4x4 或双层立体阵列。



*   **目标区域 (Target Region)**

    *   **位置**: Line ~60

    *   **参数**: `center_spot` (球心坐标 [x,y,z]), `radius_spot` (球半径 m)。

    *   **原理**: 使用 `np.linalg.norm` 计算 3D 欧氏距离，生成布尔掩膜 `region_mask`，指导求解器仅优化球体内部场强。



### 2. 工程哲学：控制阶数的“苏式截断” (Soviet Truncation)

关于梯度线圈应扩展到多少阶的问题，遵循以下工程原则：

*   **简单即可靠**: 0阶(B0) + 1阶(Gradient) 是性价比极限。2阶以上系统复杂度呈指数上升，但在远场干扰下的收益极低（衰减快，
/r^5$）。

*   **鲁棒性优先**: 高阶线圈对加工和安装公差极其敏感。

*   **结论**: 止步于 **1阶梯度**。打造“磁场界的 AK-47”——皮实、耐用、火力覆盖够用即可，拒绝学术界的“过拟合”炫技。



### 3. 跨学科创新方向 (EE $\to$ BME Cross-over)

利用电子工程 (EE) 背景对传统生物医学工程 (BME) 进行“降维打击”的潜在方向：

*   **非线性监测 (IM2/IMD)**:

    *   **思路**: 利用通信电路中的 **二阶互调 (IM2)** 概念。

    *   **应用**: 发射双导频信号，监测差频分量，以此**主动探测**环境中的隐蔽非线性干扰源（如移动的铁磁物体、屏蔽层饱和）。

*   **前馈控制融合 (Feed-forward with MoCap)**:

    *   **思路**: 引入动作捕捉 (Motion Capture) 系统。

    *   **应用**: 在磁力计读数跳变之前，通过视觉捕捉头动向量，利用物理模型提前预测磁通量变化并施加反向波。将“亡羊补牢”升级为“未卜先知”。

### 4. 核心矩阵构建原理 (Matrix Construction)
为了计算流函数系数或阵列电流，我们需要构建两个关键矩阵：

*   **$A$ 矩阵 (灵敏度矩阵 / Sensitivity Matrix)**
    *   **定义**: 描述“输入电流”与“输出磁场”之间的线性映射关系 ($\mathbf{B} = A \cdot \mathbf{x}$).
    *   **输入参数**:
        1.  **源 (Source)**: 线圈的**几何路径** (Geometry)。对于阵列，是所有单元 ($K$ 个通道) 的 3D 坐标数据。
        2.  **宿 (Sink)**: 目标区域的**采样点坐标** (Target Points)。即 $M$ 个体素中心。
        3.  **物理核**: **毕奥-萨伐尔定律** (Biot-Savart Law)。
    *   **维度**: $(3M \times K)$。

*   **$\Gamma$ 矩阵 (正则化矩阵 / Tikhonov Matrix)**
    *   **定义**: 定义优化过程中的“代价”或“惩罚项” (Penalty Term)。
    *   **输入参数**: 线圈的**电气特性**。通常基于线圈的**电阻 $R$** 或 **电感 $L$**。
    *   **物理意义**:
        *   若 $\Gamma = \mathbf{I}$ (单位阵): 最小化电流平方和 ($\min \sum I^2$)。
        *   若 $\Gamma_{ii} \propto \sqrt{R_i}$: 最小化**热功耗** ($\min P = \sum I^2 R$)。
    *   **作用**: 防止矩阵 $A$ 的病态导致电流震荡，在“拟合精度”与“系统功耗”之间寻找平衡。

    > **代码修改位置指南 (Code Modification Guide)**:
    > *   **$A$ 矩阵参数**:
    >     *   **目标点 (Sink)**: 修改 `run_array_sim.py` 中的 `## 2. Define ROI` 部分。
    >         *   `limit`: 仿真空间的坐标边界 (m)。决定了观测磁场的总体范围（如 $\pm 2.5m$）。
    >         *   `Np`: 单轴采样密度。总采样点数 $M = Np^3$。注意：$Np$ 翻倍，计算量和内存占用将变为 8 倍。
    >         *   `gx, gy, gz`: 坐标轴分量，通过 `linspace(-limit, limit, Np)` 生成。
    >         *   `target_points`: 最终的 $M \times 3$ 坐标矩阵，作为“观察者”传入物理仿真函数。
    >     *   **线圈几何 (Source)**: 
    >         *   单体参数: 修改 `src/factory.py` (如 `L`, `num_turns`) 或 `run_array_sim.py` 的 `config` 字典。
    >         *   阵列排布: 修改 `run_array_sim.py` 中的 `layout` 列表。
    > *   **$\Gamma$ 矩阵参数**:
    >     *   **权重强度**: 修改 `run_array_sim.py` 中 `config` 字典里的 `'reg_lambda'` (默认 `1e-14`)。
    >     *   **结构逻辑**: 目前默认为单位阵 (最小化电流平方)。若要改为最小化**功率** (即引入电阻 $R$ 加权)，需修改 `src/array_manager.py` 中的 `solve_optimization` 方法，构建对角矩阵 `Gamma = diag(sqrt(R))`。

## 22 Jan: “透明盾”范式与第一性原理 (Transparent Shield Paradigm)

### 1. 第一性原理与专利目标 (The First Principle)
我们的终极目标是写出并落地以下专利：
**“一种支持灵活位置控制且融合屏蔽空间镜像源补偿的主动磁屏蔽软硬件系统”**
*   **核心创新点**: 
    1.  **空间解耦**: 突破“桶型”或“固定笼子”限制，实现线圈阵列在复杂建筑环境下的自由排布（灵活位置）。
    2.  **环境共生**: 将屏蔽室金属墙视为“镜像源”而非干扰，通过算法在数学层面对齐（镜像源补偿）。

### 2. 软硬件新范式 (New Paradigm)

*   **硬件范式：独立板控 (Independent Plate Control)**
    *   **拓扑**: 3x3 阵列，每个单元由 Bx/By/Bz + 1阶梯度组成。
    *   **解耦控制**: 核心逻辑是将物理线圈的顶层（Top）与底层（Bottom）作为**独立控制通道**。这消除了冗余物理线圈（如 Gxz, Gyz），转而通过共模/差模驱动实现等效梯度。
    *   **工程规格**: 采用 4mm² 截面铜线。在保持 ~22dB 屏蔽率的前提下，成功将 `num_turns` 砍至 **10 匝**。
    *   **实感数据**: 
        *   **线长**: ~2160 米（相当于田径场 5.5 圈，或 77kg 铜）。
        *   **功耗**: **0.7 W**（极低发热，无需主动散热）。
        *   **重量**: 铜重仅为传统 MSR 钢材重量的 **1%**。

*   **软件范式：实时透明优化 (Real-time Transparency)**
    *   **算法**: Tikhonov 正则化 ($\lambda = 10^{-18}$)。
    *   **性能**: 系统切换/重算的计算延迟 **< 4ms**，满足毫秒级头部运动补偿需求。
    *   **鲁棒性**: 通过 L-Curve 扫描确定的甜点参数，平衡了抑噪深度与电流幅度。

### 3. 哲学落地：从“座架”到“栖居” (Heideggerian Transition)
*   不再强迫被试进入一个“铁笼子” (Gestell)，而是让磁场屏蔽系统像空气一样“透明”地融入建筑环境。
*   **愿景**: 去设施化 (De-infrastructure)。未来测量不在实验室，而在客厅、在诊室。

---
**当前进度**: 功率与线长危机已解除，系统已具备工程化落地的实感。下一步将重点攻克“镜像源鲁棒性”在动态环境下的边界条件。

## 23 Jan: 双层正则化架构的逻辑解析 (The Two-Lambda Paradigm)

在系统中存在两个名为 `lambda` 的正则化参数，它们处于完全不同的物理与数学维度，需严格区分：

### 1. `config['reg_lambda']` (零件级：线圈走线正则化)
*   **所属模块**: `CoilFactory` -> 流函数设计。
*   **物理意义**: 控制单块板子上**电线的“平滑度”与“疏密程度”**。
    *   **$\lambda$ 太小**: 线圈走线会异常复杂、尖锐（为了追求完美的磁场均匀度），导致难以加工。
    *   **$\lambda$ 太大**: 走线过于简单，生成的磁场与目标梯度偏差过大。
*   **调整频率**: **极低**。这是线圈“出厂”前就定好的物理设计，一旦加工完成（匝数、轨迹固定），该值即为常量。

### 2. `ARRAY_REG_LAMBDA` (系统级：电流调度正则化)
*   **所属模块**: `ArrayManager` -> 阵列电流优化。
*   **物理意义**: 控制阵列中各通道电流的**“克制程度”**，是防止“对抗电流”的核心。
    *   在强耦合（屏蔽室）环境下，系统可能为了消除微弱残差而产生巨大的对抗电流。
    *   通过 L-Curve 扫描确定的最佳值（如 `1.4e-2`）就作用于此，它在“屏蔽深度”与“功耗代价”之间寻找最优平衡。
*   **调整频率**: **高**。作为运行时（Runtime）参数，它随环境（屏蔽室尺寸、功放限制、目标区位置）的变化而动态调整。

**对比总结表：**

| 参数名称 | 关注对象 | 比喻 | 核心目的 |
| :--- | :--- | :--- | :--- |
| `config['reg_lambda']` | **线圈长什么样** | 发动机零件的精密加工 | 线圈几何的可制造性 |
| `ARRAY_REG_LAMBDA` | **线圈怎么出力** | 驾驶员踩油门的深浅 | 系统的安全性与能效比 |

### 3. 强耦合环境下的 L-Curve 行为特征
*   **特征值位移**：在屏蔽环境下，由于镜像电流的引入，响应矩阵 $S$ 的病态程度增加。实测发现系统最佳 $\lambda$ 从自由空间的 $10^{-18}$ 附近向 $10^{-16}$ 量级偏移。
*   **区间判定**：
    *   **无效区 ($\lambda > 10^{-14}$)**：电流被过度抑制（$\mu A$ 级），抑制比接近 0dB。
    *   **黄金拐点 ($\lambda \approx 2.3 \times 10^{-16}$)**：实现 ~36dB 的抑制，且总 RMS 电流控制在 ~20A（单通道约 2A），处于硬件安全区。
    *   **危险区 ($\lambda < 10^{-17}$)**：电流暴涨至 10A 以上，面临屏蔽层磁饱和风险。

### 4. 4D 时空噪声压制与“磁场像素屏”范式
*   **4D 动态验证**：通过构建“幽灵偶极子”模型，模拟了空间梯度随时间波动的场景（包含 1/f 漂移与 50Hz 工频）。
*   **频率响应**：在 0.1-100Hz 脑磁频段内，系统展现了稳定的宽频压制能力。
*   **本质区别（阵列 vs 简单缩放）**：
    *   **非等比缩放**：本系统并非简单的“大线圈缩小”，而是**空间自由度的指数级提升**。
    *   **梯度能效比**：在小尺度下，产生同样梯度所需的电流随尺寸缩放呈 $1/L^2$ 关系。阵列化提供了极高的空间采样密度，使其成为一种“磁场像素屏”，能够抹平大线圈无法触及的近场复杂梯度。

### 5. Technical Memo Agenda (小论文大纲)

**Title**: Project Nuke: A Software-Defined Active Magnetic Shielding System for Unconstrained MEG/EEG Applications

**Section 1: The Problem & The Paradigm Shift (破题)**
*   **现状 (Status Quo)**: 传统被动屏蔽（MSR）面临的“不可能三角”：造价昂贵（MuMetal）、空间幽闭（笼子）、部署困难（几吨重）。
*   **痛点 (Pain Point)**: 脑科学研究被限制在实验室，无法走向临床（如床旁监测）或家庭。
*   **新范式 (New Paradigm)**:
    *   从 "Heavy Metal" 到 "Heavy Compute"。
    *   提出 "Transparent Shield" (透明盾) 概念：基于开放式线圈阵列 + 实时视觉反馈，实现“人动盾不动，盾随人动”。

**Section 2: System Architecture & First Principles (原理)**
*   **硬件架构**:
    *   **独立板控 (Independent Plate Control)**: 3x3 阵列设计，去除了专用的梯度线圈，利用阵列差模合成高阶梯度。
    *   **极致轻量化**: 仅需 10 匝线圈，单通道 ~2A 电流（由仿真验证），无需主动散热。
*   **理论核心**:
    *   **正则化双层架构**: 区分“零件级平滑 ($\lambda_{coil}$)”与“系统级调度 ($\lambda_{array}$)”（引用 23 Jan 笔记）。
    *   **镜像源补偿**: 将屏蔽室墙壁视为“虚像阵列”，通过数学建模变废为宝，解决强耦合病态问题。

**Section 3: Key Simulation Results (核心证据)**
*   **3.1 静态寻优 (Static Optimization)**:
    *   展示 L-Curve 图。
    *   论证如何通过曲率分析找到 $\lambda = 2.3 \times 10^{-16}$，在 36dB 压制与 20A 总电流之间取得平衡。
*   **3.2 动态频域特性 (Dynamic PSD)**:
    *   展示 PSD 对比图 (0.1-100Hz)。
    *   证明系统对 1/f 漂移和 50Hz 工频的宽频带压制能力。
*   **3.3 运动鲁棒性 (Motion Robustness)**:
    *   展示 Latency vs Residual 曲线。
    *   **关键结论**: 50ms 延迟下均值误差仅增加 ~1nT。
    *   **推论**: 证明了廉价双目相机（30-60fps）方案的可行性，否定了对昂贵高速动捕的依赖。

**Section 4: Discussion: The "Magnetic Pixel" Concept (讨论)**
*   **Scaling Law 分析**: 为什么小尺寸阵列比单纯缩放的大线圈更强？
    *   **自由度爆炸**: 像屏幕像素一样，通过高密度的局部控制，抹平近场复杂梯度。
    *   **能效比**: 小尺寸产生梯度的电流代价更低 ($1/L^2$)。
*   **局限性**: 坦诚讨论对大范围运动（>20cm）的限制，以及对传感器精度的依赖。

**Section 5: Roadmap & Future Work (展望)**
*   **Phase 1 (Done)**: Python 物理全链路仿真闭环。
*   **Phase 2 (Next)**: C++ 实时求解器移植 (3ms 延迟目标) + 廉价双目视觉集成。
*   **Phase 3**: 硬件原型搭建 (MVP)。

## 26 Jan: 空间覆盖热力图与高密度阵列架构解析

### 1. 空间覆盖的物理发现：环形甜点 (The Annular Sweet Spot)
在 $Z=0.4\text{m}$ 平面（模拟人头位置）进行的压力测试（背景：150nT 均匀场 + 50nT/m 梯度场）揭示了一个有趣的物理现象：

*   **中心盲区 (Center Dip)**: 在阵列几何中心 $(0,0)$，残差反而较高 (~21 nT)。这是由于**对称性惩罚**——在中心产生特定的横向梯度 ($dB_z/dx$) 需要极大的差模电流，受到正则化参数 $\lambda$ 的强力压制。
*   **环形甜点 (Annular Sweet Spot)**: 在中心周围 $r \approx 0.4\text{m}$ 处，出现了一个完美的低残差环（~3.8 nT）。此处打破了绝对对称性，多个单元的边缘场能有效叠加，实现了低代价的高效压制。
*   **结论**: 系统的最佳工作区并非仅仅是一个点，而是一个宽广的环形平原。这为“灵活位置”提供了物理依据——被试稍微偏离中心，效果反而更好。

### 2. 硬件架构确认：108 自由度 (108 DoF)
明确了系统的控制维度，这也是其被称为“磁场像素屏”的硬件基础：

*   **单单元配置**:
    *   **基础模态 (6种)**: $B_x, B_y, B_z$ (主场) + $G_{xx}, G_{yy}, G_{xy}$ (平面梯度)。
    *   **独立板控 (x2)**: 每个模态分为 Top/Bot 两块独立板，不再强制对称/反对称驱动。
    *   **单体通道**: $6 \times 2 = \mathbf{12}$ Channels/Unit。
*   **全阵列规模**:
    *   **3x3 布局**: $9 \text{ Units} \times 12 \text{ Ch/Unit} = \mathbf{108}$ 独立控制通道。
*   **意义**: 这种超高密度的自由度（相比传统 MSR 的 ~10-20 通道）是系统能够“硬抗”复杂近场梯度、实现 4D 动态压制的物理本钱。

### 3. 未来架构精简思路 (Future Simplification)
尽管目前 "6-Base-Type" (12通道/单元) 方案提供了完备的场控制能力，但从工程量产（如 PCB 阵列化）角度考虑，存在显著的精简空间：

*   **去梯度化 (Gradient-Less Topology)**:
    *   **原理**: 随着单元密度增加（如 5x5），梯度场 $G$ 可完全由相邻单元主场 $B$ 的**空间差分**合成（例如 $G_{zx} \approx \Delta B_z / \Delta x$）。
    *   **潜力**: 可移除 $G_{xx}, G_{yy}, G_{xy}$ 物理线圈，将单体通道数减半 (12 -> 6)，极大降低功放成本。
*   **全平面化 (All-Planar Design)**:
    *   **原理**: 目前的 $B_x, B_y$ 包含垂直分量，加工复杂。若能仅通过平面螺旋线圈的组合（利用边缘效应）合成横向场，将实现 **纯 PCB 制造**。
*   **稀疏化验证**:
    *   建议在后续研究中引入 L1 正则化 (Lasso)，识别在典型噪声下的“僵尸通道”，进行针对性剔除。

---
## 抽象工作流 (Abstract Workflow) - 从设计到专利

### Phase 1: 考虑屏蔽环境的系统设计 (Shielding-Aware Design)
*   **核心挑战**: 在小型屏蔽室 (MSR) 中，金属墙壁的**镜像效应 (Mirror Effect)** 会改变线圈的有效场型，甚至导致控制矩阵 $A$ 的条件数恶化（病态程度增加）。
*   **设计逻辑**:
    1.  **虚像建模**: 利用 `physics.py` 中的镜像法 (Method of Images)，将物理墙壁转化为数学上的“虚像线圈阵列”。
    2.  **鲁棒优化**: 在计算反演矩阵时，显式包含镜像贡献 ($A_{total} = A_{real} + A_{mirror}$)。
    3.  **甜点搜索**: 利用 L-Curve 扫描，寻找在强耦合环境下的最佳 $\lambda$，防止为了抵消微弱的残差而产生巨大的“对抗电流”。

### Phase 2: COMSOL 多物理场验证 (Digital Twin Verification)
*   **必要性**: Python 仿真基于准静态 (Biot-Savart)，无法计算**涡流 (Eddy Currents)** 和 **磁滞 (Hysteresis)**。COMSOL 是验证频响特性的金标准。
*   **工作流**:
    1.  **几何导出**: 编写脚本将 Python 生成的优选线圈轨迹导出为 `.dxf` 或 `.step` 格式。
    2.  **物理设置**: 在 COMSOL AC/DC 模块中建立 MSR 模型（MuMetal + 铜层）。
    3.  **频域扫描**: 施加 0-1kHz 的激励，观察屏蔽层的涡流损耗对主动屏蔽带宽的限制。
    4.  **闭环验证**: 对比 Python 预测场与 COMSOL FEM 计算场，误差应控制在 <5%。

### Phase 3: 专利撰写与布局 (Patent Strategy)
*   **核心权利要求 (Claims)**:
    1.  **装置 (Apparatus)**: 一种基于独立板控 (Independent Plate Control) 的模块化主动磁屏蔽阵列，其特征在于消除了专用梯度线圈，仅通过阵列的差模驱动合成高阶梯度。
    2.  **方法 (Method)**: 一种在受限屏蔽空间内的自适应磁场整形方法，包括：建立镜像源模型、实时采集背景场、通过正则化算法求解包含镜像补偿的最优电流分布。
    3.  **系统 (System)**: 结合了动作捕捉 (MoCap) 与前馈控制的“透明盾”系统。
*   **撰写策略**:
    *   **背景**: 痛斥传统 MSR 的幽闭、昂贵、重型化。
    *   **实施例**: 结合 3x3 阵列的具体参数（如 0.7W 低功耗、2000米线长、22dB 抑噪）作为优选实施例，证明方案的可行性与先进性。

### 实务步骤详解：屏蔽环境下的系统设计 (Practical Steps: Shielding-Aware Design)
为了贯彻“灵活位置控制 + 镜像补偿”的第一性原理，具体执行如下：

1.  **空间标定 (Spatial Calibration)**:
    *   在 `ArrayManager` 初始化时，必须显式传入 `shield_dims` (屏蔽室半长宽)。
    *   **关键动作**: 建立局部坐标系。阵列中心可以不在房间中心（体现灵活位置），必须计算阵列相对于墙壁的精确 `offset`。

2.  **镜像矩阵注入 (Mirror Matrix Injection)**:
    *   **原理**: 每一面 MuMetal 墙壁都是一面“磁镜”。
    *   **实施**: 在计算响应矩阵 $S$ 时，不仅计算 $B_{direct}$，还要叠加 $B_{mirror}$。
    *   **深度**: 启用 `physics.py` 中的 `compute_mirror_images`，通常设定 `reflection_order=1` (6面墙) 或 `order=2` (补角反射) 即可满足精度，过高阶数边际收益递减。

3.  **病态监测 (Condition Monitoring)**:
    *   **风险**: 镜像线圈可能与真实线圈形成“近线性相关”，导致矩阵 $S$ 的条件数 (Condition Number) 暴涨，解变得极不稳定。
    *   **对策**: 在 `solve_optimization` 前，计算 `numpy.linalg.cond(S)`。如果 $> 10^5$，则需增大正则化参数 $\lambda$ 或调整阵列与墙壁的距离。

4.  **鲁棒性边界测试 (Robustness Boundary Test)**:
    *   **仿真**: 故意引入“位置误差”（如假设墙壁远了 2cm）。
    *   **观察**: 检查优化出的电流在“错误模型”下的压制效果。如果性能雪崩，说明算法过拟合；如果性能保持，说明具有工程落地价值（专利保护点）。


